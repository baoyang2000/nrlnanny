<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <title>WAV 文件播放器（按时间倒序）</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        ul { list-style: none; padding: 0; }
        li { margin: 10px 0; padding: 8px; border-bottom: 1px solid #eee; }
        audio { width: 100%; }
        .back-btn {
            display: inline-block;
            margin: 10px 0;
            padding: 6px 12px;
            background: #007cba;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
        }
        .back-btn:hover { background: #005a87; }
    </style>
</head>
<body>
    <h1>录音文件播放器（最新在前）</h1>
    <div id="content">
        <p>加载中...</p>
    </div>

    <script>
        const baseDir = '/filejson/'; // Nginx location 路径
        let currentPath = null;

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // ✅ 核心：按 mtime 倒序排序
        function sortByMtimeDescending(files) {
            return files.sort((a, b) => {
                const timeA = new Date(a.mtime).getTime();
                const timeB = new Date(b.mtime).getTime();
                return timeB - timeA; // 最新在前
            });
        }

        function loadDirectory(path) {
            const url = path + '?json';

            fetch(url)
                .then(res => res.json())
                .then(files => {
                    const content = document.getElementById('content');
                    content.innerHTML = '';

                    // 如果不是根目录，显示“返回”按钮
                    if (path !== baseDir) {
                        const backBtn = document.createElement('a');
                        backBtn.href = '#';
                        backBtn.textContent = '← 返回日期列表';
                        backBtn.className = 'back-btn';
                        backBtn.onclick = (e) => {
                            e.preventDefault();
                            loadDateList();
                        };
                        content.appendChild(backBtn);
                        content.appendChild(document.createElement('br'));
                    }

                    // ✅ 第一步：先按 mtime 倒序排序所有条目
                    const sortedFiles = sortByMtimeDescending(files);

                    const list = document.createElement('ul');

                    // 区分处理：根目录 vs 子目录
                    const isRoot = (path === baseDir);

                    sortedFiles.forEach(file => {
                        const li = document.createElement('li');

                        if (file.type === 'directory' && isRoot) {
                            // ✅ 只在根目录显示日期目录（且已按 mtime 倒序）
                            const dateMatch = file.name.match(/^(\d{4}-\d{2}-\d{2})$/);
                            if (dateMatch) {
                                const dirName = file.name + '/';
                                const encodedDir = encodeURIComponent(file.name) + '/';
                                const dateStr = new Date(file.mtime).toLocaleDateString();

                                li.innerHTML = `
                                    <div>
                                        <strong>
                                            <a href="#" onclick="event.preventDefault(); loadDirectory('${path + encodedDir}');">
                                                📁 ${dirName}
                                            </a>
                                        </strong>
                                    </div>
                                    <div style="color:#666;font-size:0.9em;">更新于: ${dateStr}</div>
                                `;
                                list.appendChild(li);
                            }
                        }
                        else if (file.type === 'file') {
                            // 是文件（JSON 中没有 type 的就是文件）
                            if (file.name.toLowerCase().endsWith('.wav')) {
                                const date = new Date(file.mtime).toLocaleTimeString();
                                const size = formatSize(file.size);

                                li.innerHTML = `
                                    <div><strong>${file.name}</strong> (${size})</div>
                                    <div style="color:#666;font-size:0.9em;">录制时间: ${date}</div>
                                    <audio controls preload="none">
                                        <source src="${path + file.name}" type="audio/wav">
                                        您的浏览器不支持 audio 元素。
                                    </audio>
                                `;
                                list.appendChild(li);
                            }
                        }
                    });

                    if (list.children.length === 0) {
                        const empty = document.createElement('p');
                        empty.textContent = '此目录为空。';
                        content.appendChild(empty);
                    } else {
                        content.appendChild(list);
                    }
                })
                .catch(err => {
                    console.error('加载失败:', err);
                    document.getElementById('content').innerHTML = `<p>错误: 无法加载目录 "${path}"</p>`;
                });
        }

        // 加载根目录（即日期列表）
        function loadDateList() {
            currentPath = null;
            loadDirectory(baseDir);
        }

        // 初始化
        loadDateList();
    </script>
</body>
</html>