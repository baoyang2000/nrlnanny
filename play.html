<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <title>录音播放器</title>
    <style>
        body { font-family: sans-serif; margin: 2rem; }
        h1 { color: #333; }
        ul { list-style: none; padding: 0; }
        li {
            margin: 0.5rem 0;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
            cursor: pointer;
        }
        li:hover { background-color: #eee; }
        audio { width: 100%; margin-top: 0.5rem; }
        .filename { font-weight: bold; color: #005a9c; }
        .timestamp { color: #555; font-size: 0.9em; }
        .back-btn {
            display: inline-block;
            margin: 1rem 0;
            padding: 0.5rem 1rem;
            background: #007cba;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .back-btn:hover { background: #005a87; }

        #mySelect {
            font-size: 18px;
        }
        @media (max-width: 600px) {
            #mySelect {
                font-size: 18px;
            }
        }

        .file-list-container {
            height: calc(100vh - 200px); /* 根据您的布局调整高度 */
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .file-list {
            /* 不需要设置高度，内容会自动撑开 */
        }

        .bottom-spacer {
            /* 高度会在JavaScript中动态设置 */
        }

        .floating-player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px;
            border-top: 1px solid #ddd;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .player-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .player-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .now-playing {
            font-weight: bold;
            flex: 1;
            font-size: 16px; /* 桌面默认字体大小 */
        }

        .player-controls {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            padding: 8px 15px;
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px; /* 桌面默认字体大小 */
        }

        .control-btn:hover {
            background: #e0e0e0;
        }

        .player-bottom-row {
            width: 100%;
        }

        .audio-container {
            width: 100%;
            min-height: 40px; /* 桌面设备默认高度 */
        }

        #globalAudioPlayer {
            width: 100%;
            min-height: 40px; /* 桌面设备默认高度 */
        }

        /* iOS 特定样式 */
        .ios-audio-container {
            min-height: 80px !important;
        }

        .ios-audio-player {
            min-height: 80px !important;
            height: 80px !important;
        }

        /* Android 设备特定样式 */
        .android-device .now-playing {
            font-size: 15px !important;
        }

        .android-device .control-btn {
            font-size: 14px !important;
            padding: 10px 12px !important;
        }

        /* iOS 设备特定样式 */
        .ios-device .now-playing {
            font-size: 17px !important;
        }

        .ios-device .control-btn {
            font-size: 16px !important;
            padding: 12px 15px !important;
        }

        /* 移动设备通用样式 */
        .mobile-audio-container {
            min-height: 80px !important;
        }

        .mobile-audio-player {
            min-height: 80px !important;
            height: 80px !important;
        }

        .mobile-floating-player {
            padding: 20px 15px !important;
        }

        /* 针对 Safari 的特殊样式 */
        @supports (-webkit-touch-callout: none) {
            .audio-container {
                min-height: 80px;
            }
            
            #globalAudioPlayer {
                min-height: 80px;
                height: 80px;
            }
        }

        /* 响应式设计 - 小屏幕设备 */
        @media (max-width: 768px) {
            .floating-player {
                padding: 20px 15px;
            }
            
            .player-content {
                max-width: 100%;
            }
            
            .player-top-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .player-controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .control-btn {
                flex: 1;
                min-height: 44px; /* 确保触摸目标足够大 */
            }
            
            .audio-container {
                min-height: 80px;
            }
            
            #globalAudioPlayer {
                min-height: 80px;
                height: 80px;
            }
            
            /* 在小屏幕上调整文件列表容器的高度 */
            .file-list-container {
                height: calc(100vh - 240px);
            }
        }

        /* 响应式设计 - 非常小的屏幕设备 */
        @media (max-width: 480px) {
            .floating-player {
                padding: 15px 10px;
            }
            
            .player-top-row {
                margin-bottom: 15px;
            }
            
            /* 在非常小的屏幕上，统一使用较小的字体 */
            .now-playing {
                font-size: 14px !important;
            }
            
            .control-btn {
                font-size: 13px !important;
                padding: 8px 10px !important;
            }
            
            .audio-container {
                min-height: 70px;
            }
            
            #globalAudioPlayer {
                min-height: 70px;
                height: 70px;
            }
        }

        .file-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .file-item:hover {
            background-color: #f5f5f5;
        }

        .file-item.playing {
            background-color: #e6f7ff;
            border-left: 3px solid #1890ff;
        }
    </style>
</head>
<body>
    <h1>录音文件浏览器</h1>
    <div id="content">
        <p>加载中...</p>
    </div>

    <script>
        const content = document.getElementById('content');

        // 显示目录列表
        function showDirs() {
            fetch('/dirs')
                .then(res => res.json())
                .then(dirs => {
                    content.innerHTML = `
                        <p>点击目录查看录音文件：</p>
                        <ul>
                            ${dirs.map(dir => `
                                <li onclick="showFiles('${dir}')">${dir}</li>
                            `).join('')}
                        </ul>
                    `;
                })
                .catch(err => {
                    content.innerHTML = `<p>加载目录失败: ${err.message}</p>`;
                    console.error(err);
                });
        }

        // 全局变量来记录当前排序方式
        let currentSortOrder = 'asc'; // 'asc' 正序, 'desc' 倒序
        let autoPlayNext = true; // 是否自动播放下一个音频
        let currentFiles = []; // 当前目录下的文件列表
        let currentDirName = ''; // 当前目录名
        let currentPlayingIndex = -1; // 当前播放的音频索引

        // 显示某目录下的文件
        function showFiles(dirName) {
            currentDirName = dirName;
            
            fetch(`/dir/${dirName}`)
                .then(res => res.json())
                .then(files => {
                    // 保存文件列表
                    currentFiles = files;
                    
                    // 根据当前排序方式排序文件
                    const sortedFiles = sortFilesByTimestamp(files, currentSortOrder);
                    
                    content.innerHTML = `
                        <a href="#" onclick="showDirs(); return false;" class="back-btn">← 返回目录</a>
                        <h2>目录: ${dirName}</h2>
                        <div class="controls">
                            <div class="sort-controls">
                                <label>排序方式: </label>
                                <select onchange="changeSortOrder(this.value, '${dirName}')">
                                    <option value="asc" ${currentSortOrder === 'asc' ? 'selected' : ''}>时间正序 (从早到晚)</option>
                                    <option value="desc" ${currentSortOrder === 'desc' ? 'selected' : ''}>时间倒序 (从晚到早)</option>
                                </select>
                            </div>
                            <div class="autoplay-controls">
                                <label>
                                    <input type="checkbox" id="autoplayToggle" ${autoPlayNext ? 'checked' : ''} onchange="toggleAutoPlay(this.checked)">
                                    自动播放下一个
                                </label>
                            </div>
                        </div>
                        <div class="file-list-container">
                            <div class="file-list">
                                ${sortedFiles.map((f, index) => `
                                    <div class="file-item ${index === currentPlayingIndex ? 'playing' : ''}" id="file-item-${index}" onclick="playFile(${index})">
                                        <div class="timestamp">${f.timestamp}</div>
                                        <div class="filename">${f.name}</div>
                                    </div>
                                `).join('')}
                                <!-- 添加底部空白元素，确保最后几个音频不会被遮挡 -->
                                <div class="bottom-spacer"></div>
                            </div>
                        </div>
                    `;
                    
                    // 确保悬浮播放器存在
                    ensureFloatingPlayer();
                    
                    // 更新悬浮播放器状态
                    updateFloatingPlayer();
                    
                    // 设置全局音频播放器事件监听
                    setupGlobalAudioPlayer();
                    
                    // 更新底部空白元素的高度
                    updateBottomSpacer();
                    
                    // 为移动设备调整布局
                    adjustForMobile();
                })
                .catch(err => {
                    content.innerHTML = `<p>加载文件失败: ${err.message}</p>`;
                    console.error(err);
                });
        }

        // 确保悬浮播放器存在
        function ensureFloatingPlayer() {
            // 检查悬浮播放器是否已存在
            let floatingPlayer = document.getElementById('floatingAudioPlayer');
            
            if (!floatingPlayer) {
                // 创建悬浮播放器
                const playerHTML = `
                    <div id="floatingAudioPlayer" class="floating-player">
                        <div class="player-content">
                            <div class="player-top-row">
                                <div class="now-playing">选择文件开始播放</div>
                                <div class="player-controls">
                                    <button onclick="playPreviousFile()" class="control-btn">上一首</button>
                                    <button onclick="playNextFile()" class="control-btn">下一首</button>
                                </div>
                            </div>
                            <div class="player-bottom-row">
                                <div class="audio-container">
                                    <audio id="globalAudioPlayer" controls preload="none" playsinline>
                                        您的浏览器不支持 audio 标签。
                                    </audio>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // 将悬浮播放器添加到页面底部
                document.body.insertAdjacentHTML('beforeend', playerHTML);
                
                // 添加iOS特定的样式调整
                adjustForIOS();
            }
        }

        // 为移动设备调整布局
        function adjustForMobile() {
            // 检测移动设备
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                const audioContainer = document.querySelector('.audio-container');
                const audioPlayer = document.getElementById('globalAudioPlayer');
                const floatingPlayer = document.getElementById('floatingAudioPlayer');
                const controlBtns = document.querySelectorAll('.control-btn');
                const nowPlaying = document.querySelector('.now-playing');
                
                if (audioContainer && audioPlayer && floatingPlayer) {
                    // 为移动设备设置更大的高度
                    audioContainer.style.minHeight = '80px';
                    audioPlayer.style.minHeight = '80px';
                    audioPlayer.style.height = '80px';
                    
                    // 增加悬浮播放器的内边距
                    floatingPlayer.style.padding = '20px 15px';
                    
                    // 检测Android设备
                    const isAndroid = /Android/i.test(navigator.userAgent);
                    
                    if (isAndroid) {
                        // Android设备 - 使用稍小的字体
                        document.body.classList.add('android-device');
                        if (nowPlaying) nowPlaying.style.fontSize = '15px';
                        controlBtns.forEach(btn => {
                            btn.style.fontSize = '14px';
                            btn.style.padding = '10px 12px';
                        });
                    } else {
                        // iOS设备 - 使用稍大的字体
                        document.body.classList.add('ios-device');
                        if (nowPlaying) nowPlaying.style.fontSize = '17px';
                        controlBtns.forEach(btn => {
                            btn.style.fontSize = '16px';
                            btn.style.padding = '12px 15px';
                        });
                    }
                    
                    // 添加移动设备特定样式类
                    audioContainer.classList.add('mobile-audio-container');
                    audioPlayer.classList.add('mobile-audio-player');
                    floatingPlayer.classList.add('mobile-floating-player');
                    
                    // 更新底部空白元素的高度
                    updateBottomSpacer();
                }
            }
        }

        // 更新底部空白元素的高度
        function updateBottomSpacer() {
            const bottomSpacer = document.querySelector('.bottom-spacer');
            const floatingPlayer = document.getElementById('floatingAudioPlayer');
            
            if (bottomSpacer && floatingPlayer) {
                // 设置底部空白元素的高度等于播放器的高度
                const playerHeight = floatingPlayer.offsetHeight;
                bottomSpacer.style.height = `${playerHeight + 20}px`; // 额外添加20px的边距
            }
        }

        // 为iOS设备调整样式
        function adjustForIOS() {
            // 检测iOS设备
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            
            if (isIOS) {
                const audioContainer = document.querySelector('.audio-container');
                const audioPlayer = document.getElementById('globalAudioPlayer');
                
                if (audioContainer && audioPlayer) {
                    // 为iOS设备设置最小高度
                    audioContainer.style.minHeight = '80px'; // 增加到80px以适配移动设备
                    audioPlayer.style.minHeight = '80px';
                    audioPlayer.style.height = '80px';
                    
                    // 添加特定的iOS样式类
                    audioContainer.classList.add('ios-audio-container');
                    audioPlayer.classList.add('ios-audio-player');
                }
            }
        }

        // 更新悬浮播放器状态
        function updateFloatingPlayer() {
            const nowPlayingElement = document.querySelector('.now-playing');
            
            if (currentPlayingIndex >= 0) {
                const sortedFiles = sortFilesByTimestamp(currentFiles, currentSortOrder);
                const file = sortedFiles[currentPlayingIndex];
                nowPlayingElement.textContent = `正在播放: ${file.name}`;
            } else {
                nowPlayingElement.textContent = '选择文件开始播放';
            }
        }

        // 根据时间戳排序文件
        function sortFilesByTimestamp(files, order) {
            return files.sort((a, b) => {
                const timeA = new Date(a.timestamp).getTime();
                const timeB = new Date(b.timestamp).getTime();
                return order === 'asc' ? timeA - timeB : timeB - timeA;
            });
        }

        // 切换排序方式
        function changeSortOrder(order, dirName) {
            currentSortOrder = order;
            // 重新显示文件
            showFiles(dirName);
        }

        // 切换自动播放设置
        function toggleAutoPlay(enabled) {
            autoPlayNext = enabled;
        }

        // 设置全局音频播放器
        function setupGlobalAudioPlayer() {
            const audioPlayer = document.getElementById('globalAudioPlayer');
            
            if (!audioPlayer) return;
            
            // 清除之前的事件监听器
            audioPlayer.onended = null;
            
            // 添加播放结束事件监听
            audioPlayer.addEventListener('ended', function() {
                if (autoPlayNext) {
                    playNextFile();
                }
            });
        }

        // 播放指定索引的文件
        function playFile(index) {
            // 获取排序后的文件列表
            const sortedFiles = sortFilesByTimestamp(currentFiles, currentSortOrder);
            
            if (index < 0 || index >= sortedFiles.length) return;
            
            const file = sortedFiles[index];
            const audioPlayer = document.getElementById('globalAudioPlayer');
            
            if (!audioPlayer) return;
            
            // 更新当前播放索引
            currentPlayingIndex = index;
            
            // 设置音频源
            audioPlayer.src = file.url;
            
            // 更新悬浮播放器显示
            updateFloatingPlayer();
            
            // 更新文件列表中的高亮状态
            updateFileListHighlight();
            
            // 滚动到正在播放的文件项
            scrollToPlayingFile();
            
            // 播放音频
            audioPlayer.play().catch(err => {
                console.error('播放音频失败:', err);
            });
        }

        // 播放上一个文件
        function playPreviousFile() {
            // 获取排序后的文件列表
            const sortedFiles = sortFilesByTimestamp(currentFiles, currentSortOrder);
            
            const prevIndex = currentPlayingIndex - 1;
            
            if (prevIndex >= 0) {
                playFile(prevIndex);
            } else {
                console.log('已经是第一个文件');
            }
        }

        // 播放下一个文件
        function playNextFile() {
            // 获取排序后的文件列表
            const sortedFiles = sortFilesByTimestamp(currentFiles, currentSortOrder);
            
            const nextIndex = currentPlayingIndex + 1;
            
            if (nextIndex < sortedFiles.length) {
                playFile(nextIndex);
            } else {
                // 已经是最后一个文件
                console.log('已经是最后一个文件，播放结束');
                currentPlayingIndex = -1;
                updateFileListHighlight();
                updateFloatingPlayer();
            }
        }

        // 更新文件列表中的高亮状态
        function updateFileListHighlight() {
            const fileItems = document.querySelectorAll('.file-item');
            
            fileItems.forEach((item, index) => {
                if (index === currentPlayingIndex) {
                    item.classList.add('playing');
                } else {
                    item.classList.remove('playing');
                }
            });
        }

        // 滚动到正在播放的文件项
        function scrollToPlayingFile() {
            if (currentPlayingIndex < 0) return;
            
            const playingElement = document.getElementById(`file-item-${currentPlayingIndex}`);
            const fileListContainer = document.querySelector('.file-list-container');
            
            if (playingElement && fileListContainer) {
                // 获取悬浮播放器的高度
                const floatingPlayer = document.getElementById('floatingAudioPlayer');
                const playerHeight = floatingPlayer ? floatingPlayer.offsetHeight : 160; // 增加默认高度，因为移动设备需要更多空间
                
                // 获取容器信息
                const containerHeight = fileListContainer.clientHeight;
                const containerScrollTop = fileListContainer.scrollTop;
                
                // 获取元素信息
                const elementOffsetTop = playingElement.offsetTop;
                const elementHeight = playingElement.offsetHeight;
                
                // 计算元素在容器视口中的位置
                const elementTopRelative = elementOffsetTop - containerScrollTop;
                const elementBottomRelative = elementTopRelative + elementHeight;
                
                // 计算可见区域的底部（减去播放器高度）
                const visibleAreaBottom = containerHeight - playerHeight;
                
                // 如果元素底部超出了可见区域（考虑播放器），则滚动
                if (elementBottomRelative > visibleAreaBottom) {
                    // 计算需要滚动的距离，使元素的底部正好在播放器上方
                    const scrollOffset = elementBottomRelative - visibleAreaBottom;
                    const targetScrollTop = containerScrollTop + scrollOffset;
                    
                    // 确保滚动位置不会超出范围
                    const maxScrollTop = fileListContainer.scrollHeight - containerHeight;
                    const clampedScrollTop = Math.max(0, Math.min(targetScrollTop, maxScrollTop));
                    
                    // 平滑滚动到目标位置
                    fileListContainer.scrollTo({
                        top: clampedScrollTop,
                        behavior: 'smooth'
                    });
                } 
                // 如果元素顶部在可见区域之上，则滚动到元素顶部
                else if (elementTopRelative < 0) {
                    fileListContainer.scrollTo({
                        top: elementOffsetTop,
                        behavior: 'smooth'
                    });
                }
            }
        }

        // 初始加载目录列表
        showDirs();
    </script>
</body>
</html>
