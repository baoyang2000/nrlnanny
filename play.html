<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <title>录音播放器</title>
    <style>
        body { font-family: sans-serif; margin: 2rem; }
        h1 { color: #333; }
        ul { list-style: none; padding: 0; }
        li {
            margin: 10px 0;
            padding: 8px;
	    border-botton: 1px solid #eee;
            background-color: #f9f9f9;
	    overflow: visible !important;
	    z-index: ;
        }
        li:hover { background-color: #eee; }
        audio { width: 100%;
		height: 96px !important;
		min-height: 48px;
		background: #f0f0f0;
		border: 1px solid #ddd;
		border-radius: 6px;
                overflow: visible !important;
		}
        .filename { font-weight: bold; color: #005a9c; }
        .timestamp { color: #555; font-size: 0.9em; }
        .back-btn {
            display: inline-block;
            margin: 1rem 0;
            padding: 0.5rem 1rem;
            background: #007cba;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .back-btn:hover { background: #005a87; }
    </style>
</head>
<body>
    <h1>录音文件浏览器</h1>
    <div id="content">
        <p>加载中...</p>
    </div>

    <script>
        const content = document.getElementById('content');
        
        // 全局变量来记录当前排序方式
        let currentSortOrder = 'asc'; // 'asc' 正序, 'desc' 倒序
        let autoPlayNext = true; // 是否自动播放下一个音频

        // 显示目录列表
        function showDirs() {
            fetch('/dirs')
                .then(res => res.json())
                .then(dirs => {
                    content.innerHTML = `
                        <p>点击目录查看录音文件：</p>
                        <ul>
                            ${dirs.map(dir => `
                                <li onclick="showFiles('${dir}')">${dir}</li>
                            `).join('')}
                        </ul>
                    `;
                })
                .catch(err => {
                    content.innerHTML = `<p>加载目录失败: ${err.message}</p>`;
                    console.error(err);
                });
        }

        // 显示某目录下的文件
        function showFiles(dirName) {
            fetch(`/dir/${dirName}`)
                .then(res => res.json())
                .then(files => {
                    // 根据当前排序方式排序文件
                    const sortedFiles = sortFilesByTimestamp(files, currentSortOrder);

                    content.innerHTML = `
                        <a href="#" onclick="showDirs(); return false;" class="back-btn">← 返回目录</a>
                        <h2>目录: ${dirName}</h2>
                        <div class="controls">
                            <div class="sort-controls">
                                <label>排序方式: </label>
                                <select onchange="changeSortOrder(this.value, '${dirName}')">
                                    <option value="asc" ${currentSortOrder === 'asc' ? 'selected' : ''}>时间正序</option>
                                    <option value="desc" ${currentSortOrder === 'desc' ? 'selected' : ''}>时间倒序</option>
                                </select>
                            </div>
                            <div class="autoplay-controls">
                                <label>
                                    <input type="checkbox" id="autoplayToggle" ${autoPlayNext ? 'checked' : ''} onchange="toggleAutoPlay(this.checked)">
                                    自动播放下一个
                                </label>
                            </div>
                        </div>
                        <ul>
                            ${sortedFiles.map(f => `
                                <li>
                                    <div class="timestamp">${f.timestamp}</div>
                                    <div class="filename">${f.name}</div>
                                    <audio controls preload="none" playsinline>
                                        <source src="${f.url}" type="audio/wav">
                                        您的浏览器不支持 audio 标签。
                                    </audio>
                                </li>
                            `).join('')}
                        </ul>
                    `;
                    // 为所有音频元素添加播放结束事件监听
                    setupAudioAutoPlay();
                })
                .catch(err => {
                    content.innerHTML = `<p>加载文件失败: ${err.message}</p>`;
                    console.error(err);
                });
        }

        // 根据时间戳排序文件
        function sortFilesByTimestamp(files, order) {
            return files.sort((a, b) => {
                const timeA = new Date(a.timestamp).getTime();
                const timeB = new Date(b.timestamp).getTime();
                return order === 'asc' ? timeA - timeB : timeB - timeA;
            });
        }

        // 切换排序方式
        function changeSortOrder(order, dirName) {
            currentSortOrder = order;
            // 重新显示文件（使用缓存的数据，避免重新请求）
            showFiles(dirName);
        }

        // 切换自动播放设置
        function toggleAutoPlay(enabled) {
            autoPlayNext = enabled;
        }

        // 设置音频自动播放下一个功能
        function setupAudioAutoPlay() {
            const audioElements = content.querySelectorAll('audio');
    
            audioElements.forEach((audio, index) => {
                // 清除之前可能存在的监听器
                audio.onplay = null;                
                audio.onended = null;

                // 添加播放事件监听 - 当播放一个音频时暂停其他所有音频
                audio.addEventListener('play', function() {
                    pauseOtherAudios(audio);
                });
        
                // 只有当自动播放开启时，才添加播放结束事件监听
                
                audio.addEventListener('ended', function() {
                    if (autoPlayNext) {
                        playNextAudio(index);
                    }
                });
            });
        }

        // 暂停除当前音频外的所有其他音频
        function pauseOtherAudios(currentAudio) {
            const audioElements = content.querySelectorAll('audio');
    
            audioElements.forEach(audio => {
                if (audio !== currentAudio && !audio.paused) {
                    audio.pause();
                   audio.currentTime = 0; // 重置播放位置
                }
            });
        }

        // 播放下一个音频
        function playNextAudio(currentIndex) {
            const audioElements = content.querySelectorAll('audio');
            const nextIndex = currentIndex + 1;
    
            // 如果存在下一个音频，则播放
            if (nextIndex < audioElements.length) {
                const nextAudio = audioElements[nextIndex];
        
                // 暂停所有其他音频
                pauseOtherAudios(nextAudio);
        
                // 播放下一个音频
                nextAudio.play().catch(err => {
                    console.error('自动播放下一个音频失败:', err);
                });
            } else {
                console.log('已经是最后一个音频，播放结束');
            }
        }

        // 初始加载目录列表
        showDirs();
    </script>
</body>
</html>
